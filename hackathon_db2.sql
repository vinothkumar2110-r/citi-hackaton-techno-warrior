CREATE TABLE "staging_trade" (
  "order_sk" NVarChar(11) NULL,
  "account_sk" NVarChar(10) NULL,
  "dwh_message_timestamp" timestamp NULL,
  "root_order_id" NVarChar(14) NULL,
  "rio_msg_source" NVarChar(12) NULL,
  "ref_msg_type" NVarChar(1) NULL,
  "order_version" NVarChar(1) NULL,
  "order_id" NVarChar(13) NULL,
  "cl_ord_id" NVarChar(15) NULL,
  "exec_id" NVarChar(8) NULL,
  "ticker_symbol" NVarChar(9) NULL,
  "side" NVarChar(1) NULL,
  "src_system_ID" NVarChar(2) NULL,
  "transaction_time" timestamp NULL,
  "dwh_update_date" NVarChar(23) NULL,
  "dwh_business_date" NVarChar(8) NULL,
  "trade_date" NVarChar(8) NULL,
  "region_cd" NVarChar(4) NULL,
  "product_code" NVarChar(23) NULL
);

insert into "staging_trade"  VALUES
('21149145765','5634374237','2020-07-01-01.56.00.000','2020070FQ4M201','AP.PTE.TRADE','A','2','94000070420QW','202324SSTEF0600','51070426','748729_AP','2','1','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','APAC','PR12123534201'),
('21149145766','5634374238','2020-07-01-01.56.00.000','2020070FQ4M202','SI.PTE.TRADE','B','1','94000170421ER','202324SSTEF0600','51070427','748731_SI','2','2','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','APAC','PR12123534202'),
('21149145767','5634374239','2020-07-01-01.56.00.000','2020070FQ4M203','JP.PTE.TRADE','C','3','94000270422TY','202324SSTEF0600','51070428','748733_JP','2','3','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','APAC','PR12123534203'),
('21149145768','5634374240','2020-07-01-01.56.00.000','2020070FQ4M204','IN.PTE.TRADE','D','2','94000370423UI','202324SSTEF0600','51070429','748734_IN','2','4','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','APAC','PR12123534204'),
('21149145769','5634374241','2020-07-01-01.56.00.000','2020070FQ4M205','SL.PTE.TRADE','E','1','94000470424OP','202324SSTEF0600','51070430','748735_SL','2','5','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','APAC','PR12123534205'),
('21149145770','5634374242','2020-07-01-01.56.00.000','2020070FQ4M206','UK.PTE.TRADE','F','3','94000570425KL','202324SSTEF0600','51070431','748736_UK','2','6','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','EMEA','PR12123534206'),
('21149145771','5634374243','2020-07-01-01.56.00.000','2020070FQ4M207','IR.PTE.TRADE','G','2','94000670426HJ','202324SSTEF0600','51070432','748737_IR','2','7','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','EMEA','PR12123534207'),
('21149145772','5634374244','2020-07-01-01.56.00.000','2020070FQ4M208','SP.PTE.TRADE','H','1','94000770427FG','202324SSTEF0600','51070433','748738_SP','2','8','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','EMEA','PR12123534208'),
('21149145773','5634374245','2020-07-01-01.56.00.000','2020070FQ4M209','IT.PTE.TRADE','I','3','94000870428SD','202324SSTEF0600','51070434','748739_IT','2','9','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','EMEA','PR12123534209'),
('21149145774','5634374246','2020-07-01-01.56.00.000','2020070FQ4M210','EN.PTE.TRADE','J','2','94000970429AZ','202324SSTEF0600','51070435','748740_EN','2','10','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','EMEA','PR12123534210'),
('21149145775','5634374247','2020-07-01-01.56.00.000','2020070FQ4M211','NY.PTE.TRADE','K','1','94001070430XC','202324SSTEF0600','51070436','748741_NY','2','11','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','NAM','PR12123534211'),
('21149145776','5634374248','2020-07-01-01.56.00.000','2020070FQ4M212','NJ.PTE.TRADE','L','3','94001170431VB','202324SSTEF0600','51070437','748742_NJ','2','12','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','NAM','PR12123534212'),
('21149145777','5634374249','2020-07-01-01.56.00.000','2020070FQ4M213','TX.PTE.TRADE','M','2','94001270432NM','202324SSTEF0600','51070438','748743_TX','2','13','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','NAM','PR12123534213'),
('21149145778','5634374250','2020-07-01-01.56.00.000','2020070FQ4M214','CA.PTE.TRADE','N','1','94001370433QW','202324SSTEF0600','51070439','748744_CA','2','14','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','NAM','PR12123534214'),
('21149145779','5634374251','2020-07-01-01.56.00.000','2020070FQ4M215','CN.PTE.TRADE','O','3','94001470434ER','202324SSTEF0600','51070440','748745_CN','2','15','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','NAM','PR12123534215'),
('21149145780','5634374252','2020-07-01-01.56.00.000','2020070FQ4M216','AP.PTE.TRADE','A','2','94001570435TY','202324SSTEF0600','51070441','748746_AP','2','1','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','APAC','PR12123534216'),
('21149145781','5634374253','2020-07-01-01.56.00.000','2020070FQ4M217','SI.PTE.TRADE','B','1','94001670436UI','202324SSTEF0600','51070442','748747_SI','2','2','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','APAC','PR12123534217'),
('21149145782','5634374254','2020-07-01-01.56.00.000','2020070FQ4M218','JP.PTE.TRADE','C','3','94001770437OP','202324SSTEF0600','51070443','748748_JP','2','3','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','APAC','PR12123534218'),
('21149145783','5634374255','2020-07-01-01.56.00.000','2020070FQ4M219','IN.PTE.TRADE','D','2','94001870438KL','202324SSTEF0600','51070444','748749_IN','2','4','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200701','20200701','APAC','PR12123534219'),
('21149145784','5634374256','2020-07-02-04.26.00.000','2020070FQ4M220','SL.PTE.TRADE','E','1','94001970439HJ','202324SSTEF0600','51070445','748750_SL','2','5','2020-07-01-11.51.00.000','2020-07-01 12.36.00.000','20200702','20200702','APAC','PR12123534220'),
('21149145785','5634374257','2020-07-02-04.26.00.000','2020070FQ4M221','UK.PTE.TRADE','F','3','94002070440FG','202324SSTEF0600','51070446','748751_UK','2','6','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','EMEA','PR12123534221'),
('21149145786','5634374258','2020-07-02-04.26.00.000','2020070FQ4M222','IR.PTE.TRADE','G','2','94002170441SD','202324SSTEF0600','51070447','748752_IR','2','7','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','EMEA','PR12123534222'),
('21149145787','5634374259','2020-07-02-04.26.00.000','2020070FQ4M223','SP.PTE.TRADE','H','1','94002270442AZ','202324SSTEF0600','51070448','748753_SP','2','8','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','EMEA','PR12123534223'),
('21149145788','5634374260','2020-07-02-04.26.00.000','2020070FQ4M224','IT.PTE.TRADE','I','3','94002370443XC','202324SSTEF0600','51070449','748754_IT','2','9','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','EMEA','PR12123534224'),
('21149145789','5634374261','2020-07-02-04.26.00.000','2020070FQ4M225','EN.PTE.TRADE','J','2','94002470444VB','202324SSTEF0600','51070450','748755_EN','2','10','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','EMEA','PR12123534225'),
('21149145790','5634374262','2020-07-02-04.26.00.000','2020070FQ4M226','NY.PTE.TRADE','K','1','94002570445NM','202324SSTEF0600','51070451','748756_NY','2','11','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','NAM','PR12123534226'),
('21149145791','5634374263','2020-07-02-04.26.00.000','2020070FQ4M227','NJ.PTE.TRADE','L','3','94002670446QW','202324SSTEF0600','51070452','748757_NJ','2','12','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','NAM','PR12123534227'),
('21149145792','5634374264','2020-07-02-04.26.00.000','2020070FQ4M228','TX.PTE.TRADE','M','2','94002770447ER','202324SSTEF0600','51070453','748758_TX','2','13','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','NAM','PR12123534228'),
('21149145793','5634374265','2020-07-02-04.26.00.000','2020070FQ4M229','CA.PTE.TRADE','N','1','94002870448TY','202324SSTEF0600','51070454','748759_CA','2','14','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','NAM','PR12123534229'),
('21149145794','5634374266','2020-07-02-04.26.00.000','2020070FQ4M230','CN.PTE.TRADE','O','3','94002970449UI','202324SSTEF0600','51070455','748760_CN','2','15','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','NAM','PR12123534230'),
('21149145795','5634374267','2020-07-02-04.26.00.000','2020070FQ4M231','AP.PTE.TRADE','A','2','94003070450OP','202324SSTEF0600','51070456','748761_AP','2','1','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','APAC','PR12123534231'),
('21149145796','5634374268','2020-07-02-04.26.00.000','2020070FQ4M232','SI.PTE.TRADE','B','1','94003170451KL','202324SSTEF0600','51070457','748762_SI','2','2','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','APAC','PR12123534232'),
('21149145797','5634374269','2020-07-02-04.26.00.000','2020070FQ4M233','JP.PTE.TRADE','C','3','94003270452HJ','202324SSTEF0600','51070458','748763_JP','2','3','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','APAC','PR12123534233'),
('21149145798','5634374270','2020-07-02-04.26.00.000','2020070FQ4M234','IN.PTE.TRADE','D','2','94003370453FG','202324SSTEF0600','51070459','748764_IN','2','4','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','APAC','PR12123534234'),
('21149145799','5634374271','2020-07-02-04.26.00.000','2020070FQ4M235','SL.PTE.TRADE','E','1','94003470454SD','202324SSTEF0600','51070460','748765_SL','2','5','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','APAC','PR12123534235'),
('21149145800','5634374272','2020-07-02-04.26.00.000','2020070FQ4M236','UK.PTE.TRADE','F','3','94003570455AZ','202324SSTEF0600','51070461','748766_UK','2','6','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','EMEA','PR12123534236'),
('21149145801','5634374273','2020-07-02-04.26.00.000','2020070FQ4M237','IR.PTE.TRADE','G','2','94003670456XC','202324SSTEF0600','51070462','748767_IR','2','7','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','EMEA','PR12123534237'),
('21149145802','5634374274','2020-07-02-04.26.00.000','2020070FQ4M238','SP.PTE.TRADE','H','1','94003770457VB','202324SSTEF0600','51070463','748768_SP','2','8','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','EMEA','PR12123534238'),
('21149145803','5634374275','2020-07-02-04.26.00.000','2020070FQ4M239','IT.PTE.TRADE','I','3','94003870458NM','202324SSTEF0600','51070464','748769_IT','2','9','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','EMEA','PR12123534239'),
('21149145804','5634374276','2020-07-02-04.26.00.000','2020070FQ4M240','EN.PTE.TRADE','J','2','94003970459QW','202324SSTEF0600','51070465','748770_EN','2','10','2020-07-02-11.50.00.000','2020-07-02 12.46.00.000','20200702','20200702','EMEA','PR12123534240'),
('21149145805','5634374277','2020-07-03-07.51.00.000','2020070FQ4M241','NY.PTE.TRADE','K','1','94004070460ER','202324SSTEF0600','51070466','748771_NY','2','11','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','NAM','PR12123534241'),
('21149145806','5634374278','2020-07-03-07.51.00.000','2020070FQ4M242','NJ.PTE.TRADE','L','3','94004170461TY','202324SSTEF0600','51070467','748772_NJ','2','12','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','NAM','PR12123534242'),
('21149145807','5634374279','2020-07-03-07.51.00.000','2020070FQ4M243','TX.PTE.TRADE','M','2','94004270462UI','202324SSTEF0600','51070468','748773_TX','2','13','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','NAM','PR12123534243'),
('21149145808','5634374280','2020-07-03-07.51.00.000','2020070FQ4M244','CA.PTE.TRADE','N','1','94004370463OP','202324SSTEF0600','51070469','748774_CA','2','14','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','NAM','PR12123534244'),
('21149145809','5634374281','2020-07-03-07.51.00.000','2020070FQ4M245','CN.PTE.TRADE','O','3','94004470464KL','202324SSTEF0600','51070470','748775_CN','2','15','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','NAM','PR12123534245'),
('21149145810','5634374282','2020-07-03-07.51.00.000','2020070FQ4M246','AP.PTE.TRADE','A','2','94004570465HJ','202324SSTEF0600','51070471','748776_AP','2','1','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','APAC','PR12123534246'),
('21149145811','5634374283','2020-07-03-07.51.00.000','2020070FQ4M247','SI.PTE.TRADE','B','1','94004670466FG','202324SSTEF0600','51070472','748777_SI','2','2','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','APAC','PR12123534247'),
('21149145812','5634374284','2020-07-03-07.51.00.000','2020070FQ4M248','JP.PTE.TRADE','C','3','94004770467SD','202324SSTEF0600','51070473','748778_JP','2','3','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','APAC','PR12123534248'),
('21149145813','5634374285','2020-07-03-07.51.00.000','2020070FQ4M249','IN.PTE.TRADE','D','2','94004870468AZ','202324SSTEF0600','51070474','748779_IN','2','4','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','APAC','PR12123534249'),
('21149145814','5634374286','2020-07-03-07.51.00.000','2020070FQ4M250','SL.PTE.TRADE','E','1','94004970469XC','202324SSTEF0600','51070475','748780_SL','2','5','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','APAC','PR12123534250'),
('21149145815','5634374287','2020-07-03-07.51.00.000','2020070FQ4M251','UK.PTE.TRADE','F','3','94005070470VB','202324SSTEF0600','51070476','748781_UK','2','6','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','EMEA','PR12123534251'),
('21149145816','5634374288','2020-07-03-07.51.00.000','2020070FQ4M252','IR.PTE.TRADE','G','2','94005170471NM','202324SSTEF0600','51070477','748782_IR','2','7','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','EMEA','PR12123534252'),
('21149145817','5634374289','2020-07-03-07.51.00.000','2020070FQ4M253','SP.PTE.TRADE','H','1','94005270472QW','202324SSTEF0600','51070478','748783_SP','2','8','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','EMEA','PR12123534253'),
('21149145818','5634374290','2020-07-03-07.51.00.000','2020070FQ4M254','IT.PTE.TRADE','I','3','94005370473ER','202324SSTEF0600','51070479','748784_IT','2','9','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','EMEA','PR12123534254'),
('21149145819','5634374291','2020-07-03-07.51.00.000','2020070FQ4M255','EN.PTE.TRADE','J','2','94005470474TY','202324SSTEF0600','51070480','748785_EN','2','10','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','EMEA','PR12123534255'),
('21149145820','5634374292','2020-07-03-07.51.00.000','2020070FQ4M256','NY.PTE.TRADE','K','1','94005570475UI','202324SSTEF0600','51070481','748786_NY','2','11','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','NAM','PR12123534256'),
('21149145821','5634374293','2020-07-03-07.51.00.000','2020070FQ4M257','NJ.PTE.TRADE','L','3','94005670476OP','202324SSTEF0600','51070482','748787_NJ','2','12','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','NAM','PR12123534257'),
('21149145822','5634374294','2020-07-03-07.51.00.000','2020070FQ4M258','TX.PTE.TRADE','M','2','94005770477KL','202324SSTEF0600','51070483','748788_TX','2','13','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','NAM','PR12123534258'),
('21149145823','5634374295','2020-07-03-07.51.00.000','2020070FQ4M259','CA.PTE.TRADE','N','1','94005870478HJ','202324SSTEF0600','51070484','748789_CA','2','14','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','NAM','PR12123534259'),
('21149145824','5634374296','2020-07-03-07.51.00.000','2020070FQ4M260','CN.PTE.TRADE','O','3','94005970479FG','202324SSTEF0600','51070485','748790_CN','2','15','2020-07-03-11.53.00.000','2020-07-03 12.32.00.000','20200703','20200703','NAM','PR12123534260'),
('21149145825','5634374297','2020-07-04-02.11.00.000','2020070FQ4M261','AP.PTE.TRADE','A','2','94006070480SD','202324SSTEF0600','51070486','748791_AP','2','1','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','APAC','PR12123534261'),
('21149145826','5634374298','2020-07-04-02.11.00.000','2020070FQ4M262','SI.PTE.TRADE','B','1','94006170481AZ','202324SSTEF0600','51070487','748792_SI','2','2','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','APAC','PR12123534262'),
('21149145827','5634374299','2020-07-04-02.11.00.000','2020070FQ4M263','JP.PTE.TRADE','C','3','94006270482XC','202324SSTEF0600','51070488','748793_JP','2','3','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','APAC','PR12123534263'),
('21149145828','5634374300','2020-07-04-02.11.00.000','2020070FQ4M264','IN.PTE.TRADE','D','2','94006370483VB','202324SSTEF0600','51070489','748794_IN','2','4','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','APAC','PR12123534264'),
('21149145829','5634374301','2020-07-04-02.11.00.000','2020070FQ4M265','SL.PTE.TRADE','E','1','94006470484NM','202324SSTEF0600','51070490','748795_SL','2','5','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','APAC','PR12123534265'),
('21149145830','5634374302','2020-07-04-02.11.00.000','2020070FQ4M266','UK.PTE.TRADE','F','3','94006570485QW','202324SSTEF0600','51070491','748796_UK','2','6','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','EMEA','PR12123534266'),
('21149145831','5634374303','2020-07-04-02.11.00.000','2020070FQ4M267','IR.PTE.TRADE','G','2','94006670486ER','202324SSTEF0600','51070492','748797_IR','2','7','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','EMEA','PR12123534267'),
('21149145832','5634374304','2020-07-04-02.11.00.000','2020070FQ4M268','SP.PTE.TRADE','H','1','94006770487TY','202324SSTEF0600','51070493','748798_SP','2','8','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','EMEA','PR12123534268'),
('21149145833','5634374305','2020-07-04-02.11.00.000','2020070FQ4M269','IT.PTE.TRADE','I','3','94006870488UI','202324SSTEF0600','51070494','748799_IT','2','9','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','EMEA','PR12123534269'),
('21149145834','5634374306','2020-07-04-02.11.00.000','2020070FQ4M270','EN.PTE.TRADE','J','2','94006970489OP','202324SSTEF0600','51070495','748800_EN','2','10','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','EMEA','PR12123534270'),
('21149145835','5634374307','2020-07-04-02.11.00.000','2020070FQ4M271','NY.PTE.TRADE','K','1','94007070490KL','202324SSTEF0600','51070496','748801_NY','2','11','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','NAM','PR12123534271'),
('21149145836','5634374308','2020-07-04-02.11.00.000','2020070FQ4M272','NJ.PTE.TRADE','L','3','94007170491HJ','202324SSTEF0600','51070497','748802_NJ','2','12','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','NAM','PR12123534272'),
('21149145837','5634374309','2020-07-04-02.11.00.000','2020070FQ4M273','TX.PTE.TRADE','M','2','94007270492FG','202324SSTEF0600','51070498','748803_TX','2','13','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','NAM','PR12123534273'),
('21149145838','5634374310','2020-07-04-02.11.00.000','2020070FQ4M274','CA.PTE.TRADE','N','1','94007370493SD','202324SSTEF0600','51070499','748804_CA','2','14','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','NAM','PR12123534274'),
('21149145839','5634374311','2020-07-04-02.11.00.000','2020070FQ4M275','CN.PTE.TRADE','O','3','94007470494AZ','202324SSTEF0600','51070500','748805_CN','2','15','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','NAM','PR12123534275'),
('21149145840','5634374312','2020-07-04-02.11.00.000','2020070FQ4M276','AP.PTE.TRADE','A','2','94007570495XC','202324SSTEF0600','51070501','748806_AP','2','1','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','APAC','PR12123534276'),
('21149145841','5634374313','2020-07-04-02.11.00.000','2020070FQ4M277','SI.PTE.TRADE','B','1','94007670496VB','202324SSTEF0600','51070502','748807_SI','2','2','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','APAC','PR12123534277'),
('21149145842','5634374314','2020-07-04-02.11.00.000','2020070FQ4M278','JP.PTE.TRADE','C','3','94007770497NM','202324SSTEF0600','51070503','748808_JP','2','3','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','APAC','PR12123534278'),
('21149145843','5634374315','2020-07-04-02.11.00.000','2020070FQ4M279','IN.PTE.TRADE','D','2','94007870498QW','202324SSTEF0600','51070504','748809_IN','2','4','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','APAC','PR12123534279'),
('21149145844','5634374316','2020-07-04-02.11.00.000','2020070FQ4M280','SL.PTE.TRADE','E','1','94007970499ER','202324SSTEF0600','51070505','748810_SL','2','5','2020-07-04-11.56.00.000','2020-07-04 12.42.00.000','20200704','20200704','APAC','PR12123534280'),
('21149145845','5634374317','2020-07-05-05.23.00.000','2020070FQ4M281','UK.PTE.TRADE','F','3','94008070500TY','202324SSTEF0600','51070506','748811_UK','2','6','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','EMEA','PR12123534281'),
('21149145846','5634374318','2020-07-05-05.23.00.000','2020070FQ4M282','IR.PTE.TRADE','G','2','94008170501UI','202324SSTEF0600','51070507','748812_IR','2','7','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','EMEA','PR12123534282'),
('21149145847','5634374319','2020-07-05-05.23.00.000','2020070FQ4M283','SP.PTE.TRADE','H','1','94008270502OP','202324SSTEF0600','51070508','748813_SP','2','8','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','EMEA','PR12123534283'),
('21149145848','5634374320','2020-07-05-05.23.00.000','2020070FQ4M284','IT.PTE.TRADE','I','3','94008370503KL','202324SSTEF0600','51070509','748814_IT','2','9','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','EMEA','PR12123534284'),
('21149145849','5634374321','2020-07-05-05.23.00.000','2020070FQ4M285','EN.PTE.TRADE','J','2','94008470504HJ','202324SSTEF0600','51070510','748815_EN','2','10','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','EMEA','PR12123534285'),
('21149145850','5634374322','2020-07-05-05.23.00.000','2020070FQ4M286','NY.PTE.TRADE','K','1','94008570505FG','202324SSTEF0600','51070511','748816_NY','2','11','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','NAM','PR12123534286'),
('21149145851','5634374323','2020-07-05-05.23.00.000','2020070FQ4M287','NJ.PTE.TRADE','L','3','94008670506SD','202324SSTEF0600','51070512','748817_NJ','2','12','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','NAM','PR12123534287'),
('21149145852','5634374324','2020-07-05-05.23.00.000','2020070FQ4M288','TX.PTE.TRADE','M','2','94008770507AZ','202324SSTEF0600','51070513','748818_TX','2','13','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','NAM','PR12123534288'),
('21149145853','5634374325','2020-07-05-05.23.00.000','2020070FQ4M289','CA.PTE.TRADE','N','1','94008870508XC','202324SSTEF0600','51070514','748819_CA','2','14','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','NAM','PR12123534289'),
('21149145854','5634374326','2020-07-05-05.23.00.000','2020070FQ4M290','CN.PTE.TRADE','O','3','94008970509VB','202324SSTEF0600','51070515','748820_CN','2','15','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','NAM','PR12123534290'),
('21149145855','5634374327','2020-07-05-05.23.00.000','2020070FQ4M291','AP.PTE.TRADE','A','2','94009070510NM','202324SSTEF0600','51070516','748821_AP','2','1','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','APAC','PR12123534291'),
('21149145856','5634374328','2020-07-05-05.23.00.000','2020070FQ4M292','SI.PTE.TRADE','B','1','94009170511QW','202324SSTEF0600','51070517','748822_SI','2','2','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','APAC','PR12123534292'),
('21149145857','5634374329','2020-07-05-05.23.00.000','2020070FQ4M293','JP.PTE.TRADE','C','3','94009270512ER','202324SSTEF0600','51070518','748823_JP','2','3','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','APAC','PR12123534293'),
('21149145858','5634374330','2020-07-05-05.23.00.000','2020070FQ4M294','IN.PTE.TRADE','D','2','94009370513TY','202324SSTEF0600','51070519','748824_IN','2','4','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','APAC','PR12123534294'),
('21149145859','5634374331','2020-07-05-05.23.00.000','2020070FQ4M295','SL.PTE.TRADE','E','1','94009470514UI','202324SSTEF0600','51070520','748825_SL','2','5','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','APAC','PR12123534295'),
('21149145860','5634374332','2020-07-05-05.23.00.000','2020070FQ4M296','UK.PTE.TRADE','F','3','94009570515OP','202324SSTEF0600','51070521','748826_UK','2','6','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','EMEA','PR12123534296'),
('21149145861','5634374333','2020-07-05-05.23.00.000','2020070FQ4M297','IR.PTE.TRADE','G','2','94009670516KL','202324SSTEF0600','51070522','748827_IR','2','7','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','EMEA','PR12123534297'),
('21149145862','5634374334','2020-07-05-05.23.00.000','2020070FQ4M298','SP.PTE.TRADE','H','1','94009770517HJ','202324SSTEF0600','51070523','748828_SP','2','8','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','EMEA','PR12123534298'),
('21149145863','5634374335','2020-07-05-05.23.00.000','2020070FQ4M299','IT.PTE.TRADE','I','3','94009870518FG','202324SSTEF0600','51070524','748829_IT','2','9','2020-07-05-11.26.00.000','2020-07-05 12.45.00.000','20200705','20200705','EMEA','PR12123534299'),
('','','','','','','','94009970519SD','202324SSTEF0600','51070525','748830_EN','2','10','2020-07-05-11.26.00.000','2020-07-05-12.45.00.000','20200705','20200705','EMEA','PR12123534300');

CREATE TABLE "ref_data" (
  "src_system_id" int NOT NULL,
  "rio_msg_source" nvarchar(15) NOT NULL,
  "bus_region_cd" char(4) NOT NULL
);

insert into "ref_data" VALUES
('1','AP.PTE.TRADE','APAC'),
('2','SI.PTE.TRADE','APAC'),
('3','JP.PTE.TRADE','APAC'),
('4','IN.PTE.TRADE','APAC'),
('5','SL.PTE.TRADE','APAC'),
('6','UK.PTE.TRADE','EMEA'),
('7','IR.PTE.TRADE','EMEA'),
('8','SP.PTE.TRADE','EMEA'),
('9','IT.PTE.TRADE','EMEA'),
('10','EN.PTE.TRADE','EMEA'),
('11','NY.PTE.TRADE','NAM'),
('12','NJ.PTE.TRADE','NAM'),
('13','TX.PTE.TRADE','NAM'),
('14','CA.PTE.TRADE','NAM'),
('15','CN.PTE.TRADE','NAM');


-- Finding and removing invalid data 
SELECT count(1) FROM "staging_trade" WHERE "order_sk" = '';
DELETE FROM "staging_trade" WHERE "order_sk" = '';

-- Correcting datatypes after cleaning for further processing
ALTER TABLE "staging_trade"
ALTER COLUMN "dwh_message_timestamp" SET DATA TYPE TIMESTAMP,
ALTER COLUMN "transaction_time" SET DATA TYPE TIMESTAMP;

-- (3) SLA - Lag between 2 records - min SLA time of 1 hr - same trade with uniq id but send the second time - what is accepted to change and what is not.
SELECT MINUTES_BETWEEN("dwh_message_timestamp","transaction_time") as SLA_Violation,count(1)
FROM "staging_trade"
where "dwh_message_timestamp" > "transaction_time"
group by MINUTES_BETWEEN("dwh_message_timestamp","transaction_time");

-- Invalid ticker symbol
SELECT count(1)
FROM "staging_trade"
where "ticker_symbol" not like '%\___';

-- Get the basic metadata for checking missing data and all other required information on dataset
SELECT count(1) as numberOfRecords,
  min(length("order_sk")) as order_sk_min_length,max(length("order_sk")) as order_sk_max_length,avg(length("order_sk")) as order_sk_avg_length,count("order_sk") as order_sk_count,count(distinct "order_sk") as order_sk_unique,
  min(length("account_sk")) as account_sk_min_length,max(length("account_sk")) as account_sk_max_length,avg(length("account_sk")) as account_sk_avg_length,count("account_sk") as account_sk_count,count(distinct "account_sk") as account_sk_unique,
  min(length("dwh_message_timestamp")) as dwh_message_timestamp_min_length,max(length("dwh_message_timestamp")) as dwh_message_timestamp_max_length,avg(length("dwh_message_timestamp")) as dwh_message_timestamp_avg_length,count("dwh_message_timestamp") as dwh_message_timestamp_count,count(distinct "dwh_message_timestamp") as dwh_message_timestamp_unique,
  min(length("root_order_id")) as root_order_id_min_length,max(length("root_order_id")) as root_order_id_max_length,avg(length("root_order_id")) as root_order_id_avg_length,count("root_order_id") as root_order_id_count,count(distinct "root_order_id") as root_order_id_unique,
  min(length("rio_msg_source")) as rio_msg_source_min_length,max(length("rio_msg_source")) as rio_msg_source_max_length,avg(length("rio_msg_source")) as rio_msg_source_avg_length,count("rio_msg_source") as rio_msg_source_count,count(distinct "rio_msg_source") as rio_msg_source_unique,
  min(length("ref_msg_type")) as ref_msg_type_min_length,max(length("ref_msg_type")) as ref_msg_type_max_length,avg(length("ref_msg_type")) as ref_msg_type_avg_length,count("ref_msg_type") as ref_msg_type_count,count(distinct "ref_msg_type") as ref_msg_type_unique,
  min(length("order_version")) as order_version_min_length,max(length("order_version")) as order_version_max_length,avg(length("order_version")) as order_version_avg_length,count("order_version") as order_version_count,count(distinct "order_version") as order_version_unique,
  min(length("order_id")) as order_id_min_length,max(length("order_id")) as order_id_max_length,avg(length("order_id")) as order_id_avg_length,count("order_id") as order_id_count,count(distinct "order_id") as order_id_unique,
  min(length("cl_ord_id")) as cl_ord_id_min_length,max(length("cl_ord_id")) as cl_ord_id_max_length,avg(length("cl_ord_id")) as cl_ord_id_avg_length,count("cl_ord_id") as cl_ord_id_count,count(distinct "cl_ord_id") as cl_ord_id_unique,
  min(length("exec_id")) as exec_id_min_length,max(length("exec_id")) as exec_id_max_length,avg(length("exec_id")) as exec_id_avg_length,count("exec_id") as exec_id_count,count(distinct "exec_id") as exec_id_unique,
  min(length("ticker_symbol")) as ticker_symbol_min_length,max(length("ticker_symbol")) as ticker_symbol_max_length,avg(length("ticker_symbol")) as ticker_symbol_avg_length,count("ticker_symbol") as ticker_symbol_count,count(distinct "ticker_symbol") as ticker_symbol_unique,
  min(length("side")) as side_min_length,max(length("side")) as side_max_length,avg(length("side")) as side_avg_length,count("side") as side_count,count(distinct "side") as side_unique,
  min(length("src_system_ID")) as src_system_ID_min_length,max(length("src_system_ID")) as src_system_ID_max_length,avg(length("src_system_ID")) as src_system_ID_avg_length,count("src_system_ID") as src_system_ID_count,count(distinct "src_system_ID") as src_system_ID_unique,
  min(length("transaction_time")) as transaction_time_min_length,max(length("transaction_time")) as transaction_time_max_length,avg(length("transaction_time")) as transaction_time_avg_length,count("transaction_time") as transaction_time_count,count(distinct "transaction_time") as transaction_time_unique,
  min(length("dwh_update_date")) as dwh_update_date_min_length,max(length("dwh_update_date")) as dwh_update_date_max_length,avg(length("dwh_update_date")) as dwh_update_date_avg_length,count("dwh_update_date") as dwh_update_date_count,count(distinct "dwh_update_date") as dwh_update_date_unique,
  min(length("dwh_business_date")) as dwh_business_date_min_length,max(length("dwh_business_date")) as dwh_business_date_max_length,avg(length("dwh_business_date")) as dwh_business_date_avg_length,count("dwh_business_date") as dwh_business_date_count,count(distinct "dwh_business_date") as dwh_business_date_unique,
  min(length("trade_date")) as trade_date_min_length,max(length("trade_date")) as trade_date_max_length,avg(length("trade_date")) as trade_date_avg_length,count("trade_date") as trade_date_count,count(distinct "trade_date") as trade_date_unique,
  min(length("region_cd")) as region_cd_min_length,max(length("region_cd")) as region_cd_max_length,avg(length("region_cd")) as region_cd_avg_length,count("region_cd") as region_cd_count,count(distinct "region_cd") as region_cd_unique,
  min(length("product_code")) as product_code_min_length,max(length("product_code")) as product_code_max_length,avg(length("product_code")) as product_code_avg_length,count("product_code") as product_code_count,count(distinct "product_code") as product_code_unique
FROM "staging_trade";

SELECT "order_sk","account_sk","dwh_message_timestamp","root_order_id","rio_msg_source","ref_msg_type","order_version","order_id","cl_ord_id","exec_id",
  "ticker_symbol","side","src_system_ID","transaction_time","dwh_update_date","dwh_business_date","trade_date","region_cd","product_code",count(1)
FROM "staging_trade"
GROUP BY "order_sk","account_sk","dwh_message_timestamp","root_order_id","rio_msg_source","ref_msg_type","order_version","order_id","cl_ord_id","exec_id",
  "ticker_symbol","side","src_system_ID","transaction_time","dwh_update_date","dwh_business_date","trade_date","region_cd","product_code"
HAVING count(1)>1;

SELECT "order_sk",count(R."rio_msg_source") "References"
FROM "staging_trade" D
LEFT JOIN "ref_data" R ON D."rio_msg_source" = R."rio_msg_source"
GROUP BY "order_sk"
HAVING count(R."rio_msg_source")=0;


INSERT INTO "refined_trades"
SELECT "order_sk","account_sk","dwh_message_timestamp","root_order_id","rio_msg_source","ref_msg_type","order_version","order_id","cl_ord_id","exec_id",
 "ticker_symbol","side","src_system_ID","transaction_time","dwh_update_date","dwh_business_date","trade_date","region_cd","product_code"
FROM (
SELECT S.*,ROWNUMBER() OVER( PARTITION BY "order_sk","account_sk","dwh_message_timestamp","root_order_id",S."rio_msg_source","ref_msg_type","order_version","order_id","cl_ord_id","exec_id",
 "ticker_symbol","side","src_system_ID","transaction_time","dwh_update_date","dwh_business_date","trade_date","region_cd","product_code" ) as appearance_rank
FROM "staging_trade" S
JOIN "ref_data" R ON S."rio_msg_source" = R."rio_msg_source" AND (S."rio_msg_source" IS NOT NULl and trim(S."rio_msg_source")!='')
WHERE ("order_sk" IS NOT NULl and trim("order_sk")!='')
AND ("account_sk" IS NOT NULl and trim("account_sk")!='')
AND ("dwh_message_timestamp" IS NOT NULl and trim("dwh_message_timestamp")!='')
AND ("root_order_id" IS NOT NULl and trim("root_order_id")!='')
AND ("ref_msg_type" IS NOT NULl and trim("ref_msg_type")!='')
AND ("order_version" IS NOT NULl and trim("order_version")!='')
AND ("order_id" IS NOT NULl and trim("order_id")!='')
AND ("cl_ord_id" IS NOT NULl and trim("cl_ord_id")!='')
AND ("exec_id" IS NOT NULl and trim("exec_id")!='')
AND ("ticker_symbol" IS NOT NULl and trim("ticker_symbol")!='')
AND ("side" IS NOT NULl and trim("side")!='')
AND ("src_system_ID" IS NOT NULl and trim("src_system_ID")!='')
AND ("transaction_time" IS NOT NULl and trim("transaction_time")!='')
AND ("dwh_update_date" IS NOT NULl and trim("dwh_update_date")!='')
AND ("dwh_business_date" IS NOT NULl and trim("dwh_business_date")!='')
AND ("trade_date" IS NOT NULl and trim("trade_date")!='')
AND ("region_cd" IS NOT NULl and trim("region_cd")!='')
AND ("product_code" IS NOT NULl and trim("product_code")!='')
AND HOURS_BETWEEN("dwh_message_timestamp","transaction_time") < 1
AND "ticker_symbol" LIKE '%\___' ESCAPE '\'
) refined_data
WHERE appearance_rank=1
